<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>CT2 Demo Dashboard · Hyper</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root { color-scheme: dark light; }
    body { margin:0; font:14px/1.5 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0b0d10; color:#e7edf3; }
    header { padding:18px 20px; border-bottom:1px solid #1b222c; display:flex; gap:16px; align-items:center; }
    .badge { font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid #2b3442; color:#c8d3e0;}
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:16px; padding:16px; }
    .card { background:#0f1319; border:1px solid #1b222c; border-radius:14px; padding:16px; box-shadow:0 2px 14px rgba(0,0,0,.25); }
    .muted { color:#9fb0c3; }
    .knum { font-size:28px; font-weight:700; letter-spacing:.3px; }
    .ok { color:#44d18d; } .warn{ color:#f6c453;} .fail{ color:#ff6b6b; }
    .controls { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    input,button,select,textarea { background:#0b0d10; color:#e7edf3; border:1px solid #273042; border-radius:10px; padding:8px 10px; }
    button { cursor:pointer; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .divider { height:1px; background:#1b222c; margin:12px 0; }
    .toast { position:fixed; right:16px; bottom:16px; background:#0f1319; border:1px solid #1b222c; padding:10px 12px; border-radius:10px; box-shadow:0 2px 14px rgba(0,0,0,.25);}
    .grid { display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; }
    .small { font-size:12px; }
    .pill { padding:2px 6px; border-radius:8px; border:1px solid #2b3442; }
    .flex { display:flex; gap:8px; align-items:center; justify-content:space-between;}
    .right { text-align:right;}
    .mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}.mt24{margin-top:24px}
    svg { display:block; width:100%; height:64px; }
    a { color:#9ad1ff; text-decoration:none; }
  </style>
</head>
<body>
<header>
  <div class="knum">CogTechAI — Demo</div>
  <span class="badge">S1 · Live</span>
  <span class="muted">Traefik → /api/* · SPA at /</span>
</header>

<section class="row">
  <div class="card">
    <div class="flex">
      <div><strong>Control Panel</strong></div>
      <div class="small muted">Values persist in localStorage</div>
    </div>
    <div class="grid mt12">
      <div>
        <div class="small muted">Base URL</div>
        <input id="base" class="mono" placeholder="http://localhost:8081"/>
      </div>
      <div>
        <div class="small muted">Org</div>
        <input id="org" class="mono" placeholder="test-org"/>
      </div>
      <div>
        <div class="small muted">x-api-key</div>
        <input id="key" class="mono" placeholder="ct2-dev-key"/>
      </div>
    </div>
    <div class="controls mt12">
      <button id="save">Save</button>
      <button id="refresh">Run Health</button>
      <button id="compute">Compute KPI</button>
      <button id="add-supplier">Add Supplier</button>
      <button id="copy-curl">Copy last cURL</button>
    </div>
    <div class="divider"></div>
    <div class="grid">
      <div>
        <div class="small muted">KPI latency</div>
        <div id="lat-kpi" class="knum ok">—</div>
      </div>
      <div>
        <div class="small muted">Supplier latency</div>
        <div id="lat-supplier" class="knum ok">—</div>
      </div>
      <div>
        <div class="small muted">Circuit</div>
        <div id="circuit" class="knum">closed</div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="flex"><strong>Throughput (sparkline)</strong><span class="small muted" id="ts-meta">k=throughput</span></div>
    <svg id="spark"></svg>
    <div class="small muted mt8">Polling every 10s · p50/p95 derived client-side</div>
  </div>
</section>

<section class="row">
  <div class="card">
    <strong>Suppliers <span class="pill muted" id="sup-count">—</span></strong>
    <pre id="sup-json" class="mono small mt8" style="white-space:pre-wrap;"></pre>
  </div>
  <div class="card">
    <strong>Recent Actions</strong>
    <pre id="log" class="mono small mt8" style="white-space:pre-wrap; height:160px; overflow:auto;"></pre>
    <div class="small muted">Traefik: <a href="http://localhost:8090" target="_blank">Dashboard</a></div>
  </div>
</section>

<div id="toast" class="toast" style="display:none;"></div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const S = {
    base: $('base'),
    org: $('org'),
    key: $('key'),
    save: $('save'),
    refresh: $('refresh'),
    compute: $('compute'),
    addSupplier: $('add-supplier'),
    copyCurl: $('copy-curl'),
    latKpi: $('lat-kpi'),
    latSupplier: $('lat-supplier'),
    circuit: $('circuit'),
    supCount: $('sup-count'),
    supJson: $('sup-json'),
    log: $('log'),
    toast: $('toast'),
    spark: $('spark'),
    tsMeta: $('ts-meta'),
  };

  // Load persisted config
  const cfg = JSON.parse(localStorage.getItem('ct2cfg')||'{}');
  S.base.value = cfg.base || 'http://localhost:8081';
  S.org.value  = cfg.org  || 'test-org';
  S.key.value  = cfg.key  || 'ct2-dev-key';

  S.save.onclick = ()=>{
    localStorage.setItem('ct2cfg', JSON.stringify({ base:S.base.value.trim(), org:S.org.value.trim(), key:S.key.value.trim() }));
    toast('Saved');
  };

  function toast(msg, ok=true){
    S.toast.textContent = msg;
    S.toast.style.display = 'block';
    S.toast.style.borderColor = ok ? '#244a3a' : '#4a2424';
    setTimeout(()=> S.toast.style.display = 'none', 1400);
  }

  // Circuit breaker
  let failures=0, openUntil=0;
  function circuitOpen(){ return Date.now() < openUntil; }
  function onFail(){
    failures++;
    if (failures>=3){
      openUntil = Date.now() + 15000; // 15s
      S.circuit.textContent = 'open';
      S.circuit.className = 'knum fail';
    }
  }
  function onSuccess(){
    failures = 0;
    if (circuitOpen()){ /* half-open success → close */ openUntil = 0; }
    S.circuit.textContent = 'closed';
    S.circuit.className = 'knum ok';
  }

  // HTTP helper with timing + last cURL
  let lastCurl = '';
  async function hit(path, options={}){
    if (circuitOpen()){
      throw new Error('circuit open');
    }
    const base = S.base.value.trim().replace(/\/+$/,'');
    const url  = base + path;
    const h = { 'x-api-key': S.key.value.trim(), ...(options.headers||{}) };
    const method = (options.method||'GET').toUpperCase();
    const body = options.body ? (typeof options.body==='string'?options.body:JSON.stringify(options.body)) : undefined;
    lastCurl = `curl -sS -X ${method} "${url}" -H "x-api-key: ${h['x-api-key']}"${body?` -H "Content-Type: application/json" -d '${body.replace(/'/g,"'\\''")}'`:''}`;
    const t0 = performance.now();
    const res = await fetch(url, { method, headers:h, body });
    const t1 = performance.now();
    const ms = Math.round(t1-t0);
    return { res, ms, json: await res.json().catch(()=>({})) };
  }

  function colorLatency(el, ms){
    el.textContent = ms+' ms';
    el.className = 'knum ' + (ms<=350?'ok': ms<=800?'warn':'fail');
  }

  // Sparkline
  function drawSpark(points){
    const el = S.spark;
    const w = el.clientWidth || 600, h=64, pad=6;
    const xs = points.map(p=>p.t), ys=points.map(p=>p.v);
    const minY = Math.min(...ys), maxY = Math.max(...ys);
    const minX = Math.min(...xs), maxX = Math.max(...xs);
    const fx = x=> pad + ( (x-minX)/(maxX-minX||1) ) * (w-2*pad);
    const fy = y=> h-pad - ( (y-minY)/(maxY-minY||1) ) * (h-2*pad);
    let d='';
    points.forEach((p,i)=> d += (i?'L':'M') + fx(p.t)+','+fy(p.v));
    el.innerHTML = `<polyline fill="none" stroke="currentColor" stroke-width="2" points="${points.map(p=>fx(p.t)+','+fy(p.v)).join(' ')}" />`;
  }

  // Polling
  async function poll(){
    try{
      // KPI health
      let r = await hit(`/api/kpi/health`);
      colorLatency(S.latKpi, r.ms);
      if (!r.res.ok) throw new Error('kpi health ' + r.res.status);
      onSuccess();
    }catch(e){ onFail(); log('kpi health: '+e.message); }

    try{
      // Suppliers
      const q = new URLSearchParams({ org_id: S.org.value.trim() }).toString();
      let r = await hit(`/api/supplier?`+q);
      colorLatency(S.latSupplier, r.ms);
      if (!r.res.ok) throw new Error('supplier '+ r.res.status);
      S.supCount.textContent = (Array.isArray(r.json)?r.json.length:0);
      S.supJson.textContent  = JSON.stringify(r.json, null, 2);
      onSuccess();
    }catch(e){ onFail(); log('supplier: '+e.message); }

    try{
      // Time-series
      const q = new URLSearchParams({ k:'throughput', org_id:S.org.value.trim() }).toString();
      let r = await hit(`/api/time-series?`+q);
      if (r.res.ok && r.json && Array.isArray(r.json.points)){
        drawSpark(r.json.points.slice(-120));
        S.tsMeta.textContent = `k=${r.json.k} · n=${r.json.points.length}`;
      }
    }catch(e){ log('ts: '+e.message); }

    // Schedule next
    setTimeout(poll, 10000);
  }

  function log(s){
    const line = new Date().toLocaleTimeString() + '  ' + s;
    S.log.textContent = line + '\n' + S.log.textContent;
  }

  // Buttons
  S.refresh.onclick = ()=>{ poll(); toast('Health run'); };
  S.compute.onclick = async ()=>{
    try{
      let r = await hit(`/api/kpi/compute`, { method:'POST', body:{} });
      toast('KPI computed'); log('kpi compute: '+(r.res.ok?'ok':'err')+' '+(r.json.computed_at||''));
    }catch(e){ toast('Compute failed', false); log('compute: '+e.message); }
  };
  S.addSupplier.onclick = async ()=>{
    try{
      let r = await hit(`/api/supplier`, { method:'POST', body:{ org_id:S.org.value.trim(), name:'Demo '+Math.floor(Math.random()*1000), country:'IN' }});
      toast('Supplier added'); log('add supplier: '+(r.res.ok?'ok':'err')+' id='+(r.json?.id||'?'));
    }catch(e){ toast('Add failed', false); log('add: '+e.message); }
  };
  S.copyCurl.onclick = async ()=>{
    try{
      await navigator.clipboard.writeText(lastCurl||'');
      toast('cURL copied');
    }catch{ toast('Copy failed', false); }
  };

  // Initial
  poll();
})();
</script>
</body>
</html>
